# Readability Guide

This guide provides best practices and style guides for various languages and tools to ensure consistency across our codebase.

## GitHub Actions

### Input Naming

-   Use `snake_case` for input names (e.g., `project_id`).
-   Be specific. Include units if applicable (e.g., `storage_size_gb`).
-   For booleans, default to `false` and name for the intended use case.

    ```yaml
    inputs:
      # Disabled by default, user must enable.
      enable_logging:
        description: "Enable the use of logging"
        required: false
        default: false

      # Enabled by default, user must disable.
      disable_cache:
        description: "Disable the use of caching"
        required: false
        default: false
    ```

### Accessing Inputs

To avoid shell injection vulnerabilities, do not access inputs directly in shell steps. Instead, map them to environment variables.

**Don't:**

```yaml
steps:
  - name: 'Check inputs'
    shell: 'bash'
    run: |-
      if [[ -z "${{ inputs.org-members-path }}" && ...
```

**Do:**

```yaml
env:
  ORG_MEMBERS_PATH: '${{ inputs.org-members-path }}'
...
steps:
  - name: 'Check inputs'
    shell: 'bash'
    run: |-
      if [[ -z "${ORG_MEMBERS_PATH}" && ...
```

---

## Go

Refer to the [Google Go style guide](https://google.github.io/styleguide/go/) first. This section covers additional conventions.

### Repository Structure

Follow the [golang-standards/project-layout](https://github.com/golang-standards/project-layout) with these additions:

```
.
├── apis/v1alpha1       # Versioned public APIs
├── sdk/go              # Go SDK (part of the main module)
├── cmd/my-cli          # CLI tools
├── protos/v1alpha1     # Protobuf definitions
├── terraform           # Terraform modules
└── test                # Integration/E2E tests
```

### Dependencies

-   **Config Loading:** [sethvargo/go-envconfig](https://github.com/sethvargo/go-envconfig) (via `abcxyz/pkg/cfgloader`)
-   **Retry Logic:** [sethvargo/go-retry](https://github.com/sethvargo/go-retry)
-   **JWT Operations:** [lestrrat-go/jwx/v2](https://github.com/lestrrat-go/jwx/v2)
-   **Common Utilities:** [abcxyz/pkg](https://github.com/abcxyz/pkg)

### General Conventions

-   **Pointers:** Use pointers for struct types and pointer receivers for methods. Use concrete types for built-in types unless you need to distinguish between empty and unprovided values.
-   **Comments:** Use `//` (not `/* */`). Wrap at 80 characters. Use Godoc features like links and lists.
-   **Flags:** Prefix flag variables with `flag` (e.g., `var flagDebugMode bool`).
-   **Imports:** Group imports in this order: standard, custom, aliased, blank, dot.
-   **Protobuf Generation:** Use `go generate` with a `//go:generate` comment.

### `realMain` Pattern

Use a `realMain(ctx context.Context) error` function to ensure proper error handling, context cancellation, and `defer` execution. The `main()` function should be a thin wrapper.

**Do:**

```go
func main() {
  ctx, done := signal.NotifyContext(context.Background(), syscall.SIGINT, syscall.SIGTERM)
  defer done()
  logger := logging.NewFromEnv("MY_SERVICE_")
  ctx = logging.WithLogger(ctx, logger)

  if err := realMain(ctx); err != nil {
    done()
    fmt.Fprintln(os.Stderr, err.Error())
    os.Exit(1)
  }
}

func realMain(ctx context.Context) error {
  // ... application logic ...
  return nil
}
```

**Don't:**

```go
// BAD - defer statements will not run
func main() {
  db, err := database.Open("...")
  if err != nil {
    log.Fatalf("failed to open database: %s", err)
  }
  defer db.Close()
  // ...
  log.Fatal(http.ListenAndServe("..."))
}
```

### Logging

-   Use `abcxyz/pkg/logging` (based on `log/slog`).
-   Use `Context` versions of logging functions (e.g., `logger.InfoContext(ctx, ...)`).
-   Log messages: lowercase, no punctuation.
-   Log keys: `snake_case`.
-   Use `With` to add persistent key-value pairs to a logger.
-   **NEVER use `log.Fatal`**. It calls `os.Exit` and skips `defer` statements.

### Binary Releases

-   **Single Binary:** Bundle functionalities into a single binary per project.
-   **Releases:** Use [goreleaser](https://goreleaser.com/). Decouple Docker image releases from SCM releases using separate config files (`goreleaser.docker.yaml`, `goreleaser.yaml`).

### Servers

-   **Ports:** Listen on a port string, not an int.
-   **Web Frameworks:** Use the standard library (`net/http`). No third-party frameworks.
-   **Graceful Stopping:** Use a `signal.NotifyContext` to handle `SIGINT` and `SIGTERM` for graceful shutdowns. Our `abcxyz/pkg/serving` package helps with this.
-   **Middleware:** Use middleware for tasks like logging or metrics. An HTTP middleware is an `http.Handler` that wraps another `http.Handler`.
-   **Routers and Handlers:**
    -   Do not use global functions like `http.ListenAndServe`.
    -   Create a dedicated `http.Server` and `http.ServeMux`.
    -   Handlers should be named `handleXX` or `HandleXX` and return an `http.Handler`.
-   **Health Checks:** Implement a health check endpoint (e.g., `/healthz` for HTTP, gRPC Health Checking Protocol for gRPC).

### Configuration

-   Use environment variables for configuration.
-   Use `sethvargo/go-envconfig` to parse structs with `env` tags.
-   Provide sane defaults.
-   Use `.env` files for local development.

### CLIs

-   Use the `abcxyz/pkg/cli` package.
-   Command structs: `XXCommand`.
-   Flag names: use dashes (`--my-flag`), not underscores.
-   Descriptions: Start with an action verb, no trailing punctuation.
-   Boolean flags: Default to `false` (e.g., `--disable-feature` instead of `--enable-feature=false`).
-   Shared flags: Create a `flags` package.
-   Flag sections: Use `ALL CAPS`.
-   Flag examples: Must be different from the default value.

### Testing

-   **Naming:** `Test[<Struct>_]<Function>[_<details>]`.
-   **Helpers:** Prefix with `test` (e.g., `testToken(t *testing.TB)`). Use `testing.TB`.
-   **Table-Driven Tests:** Use a slice of inline structs for test cases.
-   **Parallelization:** Run tests in parallel (`t.Parallel()`) whenever possible.
-   **`go test`:** Should work out of the box. Skip integration tests if dependencies are missing (`t.Skip()`).
-   **Cleanup:** Use `t.Cleanup()` to ensure resources are released.
-   **Self-Contained:** Tests should create and destroy their own resources.
-   **No Interdependencies:** Run tests with `-shuffle=on`.
-   **Real Connections:** For HTTP/gRPC, use real local connections (`httptest` for HTTP).

### Error Handling

-   Always use `fmt.Errorf` to create and wrap errors.
-   Wrap errors from external packages: `return fmt.Errorf("...: %w", err)`.

### Linting

Use `golangci-lint` with the configuration from `abcxyz/pkg/.golangci.yml`.

```sh
golangci-lint run -c <(curl https://raw.githubusercontent.com/abcxyz/pkg/main/.golangci.yml)
```

---

## JSON

-   **Property Names:** Use `camelCase`.

---

## PRs

-   **Title:** Use [Conventional Commits](https://www.conventionalcommits.org/) format.
-   **Description:** Provide context for reviewers.
-   **Size:** Keep PRs small and coherent.
-   **Long Discussions:** If a comment thread gets too long, resolve it offline or in a separate discussion.

---

## Terraform

### Readability and Ownership

-   Add `abcxyz/terraform-readability` to `.github/CODEOWNERS` for `*.tf` files.

### Directory Structure

-   All Terraform code for a service should be in a `/terraform` directory.
-   Use modules from the `abcxyz/terraform-modules` repository for reusable infrastructure.

### File Structure

-   `main.tf`: Main entrypoint for resources.
-   `variables.tf`: Input variables.
-   `outputs.tf`: Output values.
-   `terraform.tf`: Terraform and provider configuration.

### Naming Conventions

-   **Resources & Variables:** `snake_case`.
-   **GCP Resources:** Use hyphens (`-`). Use `random_id` for uniqueness.

### Attribute Ordering

Order attributes in resource and module blocks for readability:

1.  `for_each`, `count`, `provider`
2.  `source` (for modules)
3.  Resource-specific arguments (e.g., `project`, `name`)
4.  `depends_on`, `lifecycle`

### Formatting

-   Run `terraform fmt` on all files.
-   Use the HashiCorp Terraform extension for VS Code for auto-formatting.

### Modules

-   **Sourcing:** Use Git over HTTPS and pin to a specific tag or SHA.

    ```terraform
    module "my_module" {
      source = "git::https://github.com/abcxyz/terraform-modules.git//modules/my_module?ref=v1.2.3"
      # ...
    }
    ```

### Google Provider

-   **Project ID:** Pass `project_id` as a variable to resources instead of setting it at the provider level.
-   **`google-beta`:** Use only when necessary for a specific beta feature. Specify `provider = google-beta` on the resource.
-   **IAM:** Prefer non-authoritative `_member` resources over `_binding` or `_policy`.

---

## YAML

-   **Quote all strings with single quotes. (Note for GitHub actions expressions double quotes are sometimes required.)**

```yaml
# Good
abc: 'xyz'
key1: '${{ env.VAL1 }}'

# Bad
foo: bar
key2: ${{ env.VAL2 }}
```
